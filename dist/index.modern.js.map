{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["/**\r\n * Copyright (c) 2021, Anton Babakhin\r\n * All rights reserved. (MIT Licensed)\r\n *\r\n * critical-css-parser\r\n */\r\n\r\nconst httpServer = require('http-server');\r\nconst puppeteer = require('puppeteer');\r\nconst dropcss = require('dropcss');\r\nconst { get } = require('axios');\r\n\r\n/**\r\n * Receive critical and other CSS\r\n * @param  {object} options Options\r\n * @return {Promise<{ critical: string, rest: string }>} Result object with critical css and rest css\r\n */\r\nasync function criticalCSSParser(options) {\r\n  if (options.type === 'HTML') {\r\n    const {\r\n      html = '',\r\n      css = '',\r\n      whitelist = /#fooBazBarAboveTheFold8917/,\r\n      minify = false\r\n    } = options;\r\n\r\n    const { aboveTheFold, aboveTheFoldMob } = await puppeteerResources({\r\n      html,\r\n      css,\r\n      type: options.type\r\n    });\r\n\r\n    return extract(aboveTheFold, aboveTheFoldMob, css, whitelist, minify);\r\n  } else if (options.type === 'URL') {\r\n    const {\r\n      URL = '',\r\n      enableGoogleFonts = 0,\r\n      whitelist = /#fooBazBarAboveTheFold8917/,\r\n      minify = false\r\n    } = options;\r\n\r\n    const { aboveTheFold, aboveTheFoldMob, css } = await puppeteerResources({\r\n      enableGoogleFonts,\r\n      url: URL,\r\n      type: options.type\r\n    });\r\n\r\n    return extract(aboveTheFold, aboveTheFoldMob, css, whitelist, minify);\r\n  } else if (options.type === 'localServer') {\r\n    const {\r\n      entrypoint = '',\r\n      filename = 'index.html',\r\n      enableGoogleFonts = 0,\r\n      whitelist = /#fooBazBarAboveTheFold8917/,\r\n      minify = false\r\n    } = options;\r\n\r\n    // Create local server to open the page\r\n    const server = httpServer.createServer({ root: entrypoint });\r\n    server.listen(6543);\r\n\r\n    const { aboveTheFold, aboveTheFoldMob, css } = await puppeteerResources({\r\n      enableGoogleFonts,\r\n      url: `http://127.0.0.1:6543/${filename}`,\r\n      type: options.type\r\n    });\r\n\r\n    server.close();\r\n\r\n    return extract(aboveTheFold, aboveTheFoldMob, css, whitelist, minify);\r\n  }\r\n}\r\n\r\n/**\r\n * Receive above-the-fold HTML\r\n * @param  {object} page Page from Puppeteer\r\n * @param  {number} height Height of viewport\r\n * @return {Promise<string>} Result html\r\n */\r\nasync function getAboveTheFoldHTML(page, height) {\r\n  await page.$$eval('body *:not(script):not(style)', (elems, height) => {\r\n    Array.from(elems).forEach(elem => {\r\n      try {\r\n        const computedStyle = window.getComputedStyle(elem);\r\n        let top = 0;\r\n        let marginTop = 0;\r\n\r\n        const computedTop = computedStyle.top;\r\n        if (computedTop.indexOf('px') !== -1) {\r\n          top = Math.abs(Number.parseInt(computedTop, 10));\r\n        } else if (computedTop.indexOf('%') !== -1) {\r\n          const parentHeight = elem.parentElement.offsetHeight;\r\n          const percent = Math.abs(Number.parseInt(computedTop, 10));\r\n          top = (parentHeight * percent) / 100;\r\n        }\r\n\r\n        const computedMarginTop = computedStyle.marginTop;\r\n        marginTop = Math.abs(Number.parseInt(computedMarginTop, 10));\r\n\r\n        if (elem.getBoundingClientRect().top - marginTop - top + pageYOffset > height) {\r\n          // Remove element below the fold\r\n          elem.remove();\r\n        } else {\r\n          const parentComputedStyle = window.getComputedStyle(elem.parentElement);\r\n          if (\r\n            parentComputedStyle.display === 'none'\r\n            || (\r\n              parentComputedStyle.overflow === 'hidden'\r\n              && (parentComputedStyle.height === '0px' || parentComputedStyle.width === '0px')\r\n            )\r\n          ) {\r\n            // Remove hidden element\r\n            elem.remove();\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.error(e);\r\n      }\r\n    });\r\n  }, height);\r\n\r\n  const html = await page.content();\r\n  return html;\r\n}\r\n\r\n/**\r\n * Receive resources from Puppeteer\r\n * @param  {object} options Launch options\r\n * @return {Promise<{ aboveTheFold: string, aboveTheFoldMob: string, css: string }>} Result resources\r\n */\r\nasync function puppeteerResources(options) {\r\n  const cache = { };\r\n  const browser = await puppeteer.launch();\r\n  let cssString = '';\r\n  // Puppeteer page with desktop version\r\n  const context = await browser.createIncognitoBrowserContext();\r\n  const page = await context.newPage();\r\n  await page.setRequestInterception(true);\r\n  page.on('request', interceptedRequest => {\r\n    if (interceptedRequest.url().indexOf('.css') !== -1) {\r\n      cache[interceptedRequest.url()] = interceptedRequest;\r\n    }\r\n    interceptedRequest.continue();\r\n  });\r\n  // Puppeteer page with mobile version\r\n  const context2 = await browser.createIncognitoBrowserContext();\r\n  const page2 = await context2.newPage();\r\n\r\n  await Promise.all([new Promise(async (res, rej) => {\r\n    await page.setDefaultNavigationTimeout(120000);\r\n    await page.setViewport({ width: 1920, height: 1200 });\r\n    if (options.type === 'HTML') {\r\n      await page.setContent(options.html, { waitUntil: 'networkidle2'\t});\r\n      await page.addStyleTag({ content: options.css });\r\n    } else {\r\n      await page.goto(options.url, { waitUntil: 'networkidle2' });\r\n      let styleHrefs = await page.$$eval(':not(noscript) > link[rel=stylesheet]', elems => Array.from(elems).map(s => s.href));\r\n      if (!options.enableGoogleFonts) {\r\n        styleHrefs = styleHrefs.filter(href => href.indexOf('fonts.googleapis.com') === -1);\r\n      }\r\n      // Concatenate all styles\r\n      await Promise.all(styleHrefs.map(async href => {\r\n        if (cache[href]) {\r\n          let data = await cache[href].response().text();\r\n          cssString += data;\r\n        } else {\r\n          let { data } = await get(href);\r\n          cssString += data;\r\n        }\r\n      }));\r\n    }\r\n    res();\r\n  }), new Promise(async (res, rej) => {\r\n    await page2.setDefaultNavigationTimeout(60000);\r\n    await page2.setViewport({ width: 480, height: 650, isMobile: true, hasTouch: true });\r\n    if (options.type === 'HTML') {\r\n      await page2.setContent(options.html, { waitUntil: 'networkidle2' });\r\n      await page2.addStyleTag({ content: options.css });\r\n    } else {\r\n      await page2.goto(options.url, { waitUntil: 'networkidle2' });\r\n    }\r\n    res();\r\n  })]);\r\n\r\n  const aboveTheFold = await getAboveTheFoldHTML(page, 1200);\r\n  const aboveTheFoldMob = await getAboveTheFoldHTML(page2, 650);\r\n\r\n  await browser.close();\r\n\r\n  return { aboveTheFold, aboveTheFoldMob, css: cssString };\r\n}\r\n\r\n/**\r\n * Extract critical and rest CSS from HTML\r\n * @param  {string} deskHTML HTML of desktop version\r\n * @param  {string} mobHTML HTML of mobile version\r\n * @param  {string} css CSS\r\n * @param  {RegExp} whitelist Regular Expression of needed tags\r\n * @return {Promise<{ critical: string, rest: string }>} Result object with critical css and rest css\r\n */\r\nfunction extract(deskHTML, mobHTML, css, whitelist, minify) {\r\n  // Receive above-the-fold css-selectors of desktop version\r\n  let resDesk = dropcss({\r\n    css,\r\n    html: deskHTML,\r\n    shouldDrop: sel => !whitelist.test(sel)\r\n  });\r\n\r\n  // Receive above-the-fold css-selectors of mobile version\r\n  let resMob = dropcss({\r\n    css,\r\n    html: mobHTML,\r\n    shouldDrop: sel => !whitelist.test(sel)\r\n  });\r\n\r\n  let selectors = new Set();\r\n\tresDesk.sels.forEach(sel => selectors.add(sel));\r\n\tresMob.sels.forEach(sel => selectors.add(sel));\r\n\r\n  let above = dropcss({\r\n    css,\r\n    html: '',\r\n    shouldDrop: sel => !selectors.has(sel)\r\n  });\r\n\r\n  let rest = dropcss({\r\n    css,\r\n    html: '',\r\n    shouldDrop: sel => selectors.has(sel)\r\n  });\r\n\r\n  if (minify) {\r\n    const csso = require('csso');\r\n    above.css = csso.minify(above.css).css;\r\n    rest.css = csso.minify(rest.css).css;\r\n  }\r\n\r\n  return { critical: above.css, rest: rest.css };\r\n}\r\n\r\nmodule.exports = criticalCSSParser;\r\n"],"names":["httpServer","require","puppeteer","dropcss","get","async","getAboveTheFoldHTML","page","height","$$eval","elems","Array","from","forEach","elem","computedStyle","window","getComputedStyle","top","marginTop","computedTop","indexOf","Math","abs","Number","parseInt","parentElement","offsetHeight","getBoundingClientRect","pageYOffset","remove","parentComputedStyle","display","overflow","width","e","console","error","content","puppeteerResources","options","cache","browser","launch","cssString","context","createIncognitoBrowserContext","newPage","setRequestInterception","on","interceptedRequest","url","continue","context2","page2","Promise","all","res","rej","setDefaultNavigationTimeout","setViewport","type","setContent","html","waitUntil","addStyleTag","css","goto","styleHrefs","map","s","href","enableGoogleFonts","filter","data","response","text","isMobile","hasTouch","aboveTheFold","aboveTheFoldMob","close","extract","deskHTML","mobHTML","whitelist","minify","resDesk","shouldDrop","sel","test","resMob","selectors","Set","sels","add","above","has","rest","csso","critical","module","exports","URL","entrypoint","filename","server","createServer","root","listen"],"mappings":"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"}