const e=require("http-server"),t=require("puppeteer"),o=require("dropcss"),{get:a}=require("axios");async function s(e,t){return await e.$$eval("body *:not(script):not(style)",(e,t)=>{Array.from(e).forEach(e=>{try{const o=window.getComputedStyle(e);let a=0,s=0;const i=o.top;if(-1!==i.indexOf("px")?a=Math.abs(Number.parseInt(i,10)):-1!==i.indexOf("%")&&(a=e.parentElement.offsetHeight*Math.abs(Number.parseInt(i,10))/100),s=Math.abs(Number.parseInt(o.marginTop,10)),e.getBoundingClientRect().top-s-a+pageYOffset>t)e.remove();else{const t=window.getComputedStyle(e.parentElement);"none"!==t.display&&("hidden"!==t.overflow||"0px"!==t.height&&"0px"!==t.width)||e.remove()}}catch(e){console.error(e)}})},t),await e.content()}async function i(e){const o={},i=await t.launch();let n="";const r=await i.createIncognitoBrowserContext(),l=await r.newPage();await l.setRequestInterception(!0),l.on("request",e=>{-1!==e.url().indexOf(".css")&&(o[e.url()]=e),e.continue()});const c=await i.createIncognitoBrowserContext(),w=await c.newPage();await Promise.all([new Promise(async(t,s)=>{if(await l.setDefaultNavigationTimeout(12e4),await l.setViewport({width:1920,height:1200}),"HTML"===e.type)await l.setContent(e.html,{waitUntil:"networkidle2"}),await l.addStyleTag({content:e.css});else{await l.goto(e.url,{waitUntil:"networkidle2"});let t=await l.$$eval(":not(noscript) > link[rel=stylesheet]",e=>Array.from(e).map(e=>e.href));e.enableGoogleFonts||(t=t.filter(e=>-1===e.indexOf("fonts.googleapis.com"))),await Promise.all(t.map(async e=>{if(o[e]){let t=await o[e].response().text();n+=t}else{let{data:t}=await a(e);n+=t}}))}t()}),new Promise(async(t,o)=>{await w.setDefaultNavigationTimeout(6e4),await w.setViewport({width:480,height:650,isMobile:!0,hasTouch:!0}),"HTML"===e.type?(await w.setContent(e.html,{waitUntil:"networkidle2"}),await w.addStyleTag({content:e.css})):await w.goto(e.url,{waitUntil:"networkidle2"}),t()})]);const h=await s(l,1200),d=await s(w,650);return await i.close(),{aboveTheFold:h,aboveTheFoldMob:d,css:n}}function n(e,t,a,s,i){let n=o({css:a,html:e,shouldDrop:e=>!s.test(e)}),r=o({css:a,html:t,shouldDrop:e=>!s.test(e)}),l=new Set;n.sels.forEach(e=>l.add(e)),r.sels.forEach(e=>l.add(e));let c=o({css:a,html:"",shouldDrop:e=>!l.has(e)}),w=o({css:a,html:"",shouldDrop:e=>l.has(e)});if(i){const e=require("csso");c.css=e.minify(c.css).css,w.css=e.minify(w.css).css}return{critical:c.css,rest:w.css}}module.exports=async function(t){if("HTML"===t.type){const{html:e="",css:o="",whitelist:a=/#fooBazBarAboveTheFold8917/,minify:s=!1}=t,{aboveTheFold:r,aboveTheFoldMob:l}=await i({html:e,css:o,type:t.type});return n(r,l,o,a,s)}if("URL"===t.type){const{URL:e="",enableGoogleFonts:o=0,whitelist:a=/#fooBazBarAboveTheFold8917/,minify:s=!1}=t,{aboveTheFold:r,aboveTheFoldMob:l,css:c}=await i({enableGoogleFonts:o,url:e,type:t.type});return n(r,l,c,a,s)}if("localServer"===t.type){const{entrypoint:o="",filename:a="index.html",enableGoogleFonts:s=0,whitelist:r=/#fooBazBarAboveTheFold8917/,minify:l=!1}=t,c=e.createServer({root:o});c.listen(6543);const{aboveTheFold:w,aboveTheFoldMob:h,css:d}=await i({enableGoogleFonts:s,url:`http://127.0.0.1:6543/${a}`,type:t.type});return c.close(),n(w,h,d,r,l)}};
//# sourceMappingURL=index.modern.js.map
