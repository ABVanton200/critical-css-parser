const e=require("http-server"),t=require("puppeteer"),o=require("dropcss"),{get:a}=require("axios");async function s(e,t){return await e.$$eval("body *:not(script):not(style)",(e,t)=>{Array.from(e).forEach(e=>{try{const o=window.getComputedStyle(e);let a=0,s=0;const i=o.top;if(-1!==i.indexOf("px")?a=Math.abs(Number.parseInt(i,10)):-1!==i.indexOf("%")&&(a=e.parentElement.offsetHeight*Math.abs(Number.parseInt(i,10))/100),s=Math.abs(Number.parseInt(o.marginTop,10)),e.getBoundingClientRect().top-s-a+pageYOffset>t)e.remove();else{const t=window.getComputedStyle(e.parentElement);"none"!==t.display&&("hidden"!==t.overflow||"0px"!==t.height&&"0px"!==t.width)||e.remove()}}catch(e){console.error(e)}})},t),await e.content()}async function i(e){const o=await t.launch();let i="";const n=await o.newPage();if(await n.setDefaultNavigationTimeout(12e4),await n.setViewport({width:1920,height:1200}),"HTML"===e.type)await n.setContent(e.html,{waitUntil:"networkidle2"}),await n.addStyleTag({content:e.css});else{await n.goto(e.url,{waitUntil:"networkidle2"});let t=await n.$$eval(":not(noscript) > link[rel=stylesheet]",e=>Array.from(e).map(e=>e.href));e.enableGoogleFonts||(t=t.filter(e=>-1===e.indexOf("fonts.googleapis.com"))),await Promise.all(t.map(async e=>{let{data:t}=await a(e);i+=t}))}const l=await o.newPage();await l.setDefaultNavigationTimeout(6e4),await l.setViewport({width:480,height:650,isMobile:!0,hasTouch:!0}),"HTML"===e.type?(await l.setContent(e.html,{waitUntil:"networkidle2"}),await l.addStyleTag({content:e.css})):await l.goto(e.url,{waitUntil:"networkidle2"});const r=await s(n,1200),c=await s(l,650);return await o.close(),{aboveTheFold:r,aboveTheFoldMob:c,css:i}}function n(e,t,a,s,i){let n=o({css:a,html:e,shouldDrop:e=>!s.test(e)}),l=o({css:a,html:t,shouldDrop:e=>!s.test(e)}),r=new Set;n.sels.forEach(e=>r.add(e)),l.sels.forEach(e=>r.add(e));let c=o({css:a,html:"",shouldDrop:e=>!r.has(e)}),h=o({css:a,html:"",shouldDrop:e=>r.has(e)});if(i){const e=require("csso");c.css=e.minify(c.css).css,h.css=e.minify(h.css).css}return{critical:c.css,rest:h.css}}module.exports=async function(t){if("HTML"===t.type){const{html:e="",css:o="",whitelist:a=/#fooBazBarAboveTheFold8917/,minify:s=!1}=t,{aboveTheFold:l,aboveTheFoldMob:r}=await i({html:e,css:o,type:t.type});return n(l,r,o,a,s)}if("URL"===t.type){const{URL:e="",enableGoogleFonts:o=0,whitelist:a=/#fooBazBarAboveTheFold8917/,minify:s=!1}=t,{aboveTheFold:l,aboveTheFoldMob:r,css:c}=await i({enableGoogleFonts:o,url:e,type:t.type});return n(l,r,c,a,s)}if("localServer"===t.type){const{entrypoint:o="",filename:a="index.html",enableGoogleFonts:s=0,whitelist:l=/#fooBazBarAboveTheFold8917/,minify:r=!1}=t,c=e.createServer({root:o});c.listen(6543);const{aboveTheFold:h,aboveTheFoldMob:w,css:d}=await i({enableGoogleFonts:s,url:`http://127.0.0.1:6543/${a}`,type:t.type});return c.close(),n(h,w,d,l,r)}};
//# sourceMappingURL=index.modern.js.map
