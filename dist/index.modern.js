const t=require("http-server"),e=require("puppeteer"),a=require("dropcss"),{get:i}=require("axios");async function o(t,e){return await t.$$eval("body *:not(script):not(style)",(t,e)=>{Array.from(t).forEach(t=>{if(t.getBoundingClientRect().top+pageYOffset>e)try{t.remove()}catch(t){console.log(t)}})},e),await t.content()}function s(t,e,i,o,s){let n=a({html:t,css:i,shouldDrop:t=>!o.test(t)}),l=a({html:e,css:i,shouldDrop:t=>!o.test(t)}),w=new Set;n.sels.forEach(t=>w.add(t)),l.sels.forEach(t=>w.add(t));let r=a({html:"",css:i,shouldDrop:t=>!w.has(t)}),c=a({html:"",css:i,shouldDrop:t=>w.has(t)});if(s){const t=require("csso");r.css=t.minify(r.css).css,c.css=t.minify(c.css).css}return{critical:r.css,rest:c.css}}module.exports=async function(a){if("HTML"===a.type){const{html:t="",css:i="",whitelist:n=/#fooBazBarAboveTheFold8917/,minify:l=!1}=a,w=await e.launch(),r=await w.newPage();await r.setDefaultNavigationTimeout(6e4),await r.setContent(t,{waitUntil:"networkidle2"}),await r.addStyleTag({content:i}),await r.setViewport({width:1920,height:1200});const c=await w.newPage();await c.setDefaultNavigationTimeout(6e4),await c.setContent(t,{waitUntil:"networkidle2"}),await c.addStyleTag({content:i}),await c.setViewport({width:480,height:650,isMobile:!0,hasTouch:!0});const h=await o(r,1200),f=await o(c,650);return await w.close(),s(h,f,i,n,l)}if("URL"===a.type){const{URL:t="",enableGoogleFonts:n=0,whitelist:l=/#fooBazBarAboveTheFold8917/,minify:w=!1}=a,r=await e.launch(),c=await r.newPage();await c.setDefaultNavigationTimeout(6e4),await c.goto(t,{waitUntil:"networkidle2"}),await c.setViewport({width:1920,height:1200});let h=await c.$$eval("link[rel=stylesheet]",t=>Array.from(t).map(t=>t.href));n||(h=h.filter(t=>-1===t.indexOf("fonts.googleapis.com")));const f=await r.newPage();await f.setDefaultNavigationTimeout(6e4),await f.goto(t,{waitUntil:"networkidle2"}),await f.setViewport({width:480,height:650,isMobile:!0,hasTouch:!0});const u=await o(c,1200),d=await o(f,650);await r.close();let g="";return await Promise.all(h.map(async t=>{let{data:e}=await i(t);g+=e})),s(u,d,g,l,w)}if("localServer"===a.type){const{entrypoint:n="",filename:l="index.html",enableGoogleFonts:w=0,whitelist:r=/#fooBazBarAboveTheFold8917/,minify:c=!1}=a,h=t.createServer({root:n});h.listen(6543);const f=await e.launch(),u=await f.newPage();await u.setDefaultNavigationTimeout(6e4),await u.goto(`http://127.0.0.1:6543/${l}`,{waitUntil:"networkidle2"}),await u.setViewport({width:1920,height:1200});let d=await u.$$eval("link[rel=stylesheet]",t=>Array.from(t).map(t=>t.href));w||(d=d.filter(t=>-1===t.indexOf("fonts.googleapis.com")));const g=await f.newPage();await g.setDefaultNavigationTimeout(6e4),await g.goto(`http://127.0.0.1:6543/${l}`,{waitUntil:"networkidle2"}),await g.setViewport({width:480,height:650,isMobile:!0,hasTouch:!0});const m=await o(u,1200),p=await o(g,650);await f.close();let y="";return await Promise.all(d.map(async t=>{let{data:e}=await i(t);y+=e})),h.close(),s(m,p,y,r,c)}};
//# sourceMappingURL=index.modern.js.map
